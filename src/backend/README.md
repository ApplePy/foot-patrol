# Foot Patrol API Backend

Written in Typescript, this supplies the backend to the Foot Patrol application.

## Dependencies

* NodeJS
* MySQL

## How to Run

Ensure MySQL database has the appropriate schema. See `sql_statements.sql` for commands.

Provide the environment variables `MYSQL_HOST`, `MYSQL_USER`, `MYSQL_PASS`, and `MYSQL_DB` before starting the server.

The `package.json` file supports multiple ways to start the server:

* `npm start`: Start the server without auto-reload.
* `npm run dev`/`npm run dev-win`: Start the server in development mode.
* `npm run build`/`npm run build_production`: Build the server and output to `dist/`

## Folder structure

```
backend
├── apidocs
├── dist
├── docs
├── coverage
├── node_modules
├── src
│   ├── routes
│   └── services
└── test
```

`apidocs/`, generated by `npm run docs`, provides the API call documentation for this server.

`docs/`, generated by `npm run docs`, provides the code-level class documentation for this server.

`coverage/`, generated by `npm run coverage`, provides code coverage statistics for the tests.

`src/` contains all the code for this project. It contains an `ids` file for Dependency Injection symbols (powered by InversifyJS), along with `index` and `server` for starting up ExpressJS and attaching to NodeJS.

`routes/` contains the base route interface that all routes should extend, and all routes.

`services/` contains services that the API server relies on, along with relevant interface files. Files of note:

* `mysql-service.ts` supports connecting to MySQL database.

`test/` contains the testing suite. In particular, it contains `fake-sql.ts` that abstracts away the need for a running MySQL database during testing, and allows custom responses

`dist/`, generated by `npm run build` or `npm run build_production`, contains compiled code.

## Tools

This repository contains numerous tools - some code-level and some wrapped in handy `npm run` script.

### NPM Scripts

* `dev`: Start the server in development mode with auto-reload.
* `dev-win`: Windows-version of `dev`.
* `build`: Build the server with useful development flags on.
* `build_production`: Build server for production use.
* `start`: Start the server based on NODE_ENV variable.
* `docs`: Generate API and Class documentation
* `test`: Run tests to check for failures and regressions.
* `coverage`: Check test code coverage.
* `lint`: Check for code-quality issues and best-practice violations.
* `clean`: Clean up compilation, documentation, and test coverage files.

### Code-Level Tools

* API documentation is supported by `@api*Whatever*` comments above each public function, from which the API docs are generated from. These need to be kept up-to-date, and the old comment block copied to `_apidoc.js` to allow for API versioning(Useful for checking for API-breaking changes).
* Class documentation is supported by `@params` and `@returns`.
* `loggers` provides stack trace injection into API responses during development mode, and automatically sanitizes error outputs of sensitive information during production mode. In addition, in conjunction with `status-error`, provides the ability to customize the error message and HTTP Status Code returned.
* The entire backend is build using Dependency Injection via the InversifyJS library. This allows required services (e.g. `MySQLService`) to be created and injected into the class at instantiation. This also allows swapping out `MySQLService` for `FakeSQL` during testing. Please see existing routes to see usage, and `index.ts` to see how the supporting IoC container is created and used.

## Creating New Routes Steps

1. Create new route in `routes.ts`, mark as `@injectable()`, and inject the needed services.
1. Create new **TAG** in `ids.ts`
1. Add new route to `server.ts` constructor with tag, and hook up to express router.
1. Add route with tag to IoC container in `index.ts` with tag.
